{% extends 'base.html' %}
{% load static %}
{% block title %}
    All Scenarios
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <style>

        .btn-info {
            background: rgba(6, 182, 212, 0.9);
            border: none;
            color: white;
        }

        .btn-info:hover {
            background: rgba(6, 182, 212, 1);
            color: white;
            transform: translateY(-2px);
        }

        .btn-outline-primary {
            border-color: rgba(59, 130, 246, 0.5);
            color: rgba(59, 130, 246, 0.9);
        }

        .btn-outline-danger {
            border-color: rgba(239, 68, 68, 0.5);
            color: rgba(239, 68, 68, 0.9);
        }

        .card-body {
            padding: 1.5rem;
        }

        .badge {
            backdrop-filter: blur(5px);
            font-weight: 500;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="animated_background bg_fi"></div>
    {% if user.is_staff %}
        <div class="base_container">
            <div class="container py-5">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center">
                    <div class="base_header">
                        <h2 class=" mb-0">
                            <i class="fas fa-laptop-code me-2"></i>
                            All Scenarios
                        </h2>
                        <p class="scenario_text mt-2">Manage all scenarios and their steps</p>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="base_card all_scenario_card shadow-sm mb-4">
                    <div class="card-body">
                        <form method="get" class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label for="group" class="base_header scenario_all_header">Filter by Group</label>
                                <select class="form-select custom-select" id="group" name="group">
                                    <option value="">All Groups</option>
                                    {% for group in groups %}
                                        <option value="{{ group.id }}"
                                                {% if selected_group == group.id %}selected{% endif %}>
                                            {{ group.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="search" class="form-label">Search Scenarios</label>
                                <input type="text" class="form-control" id="search" name="search"
                                       value="{{ search_query }}" placeholder="Search by name...">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-filter me-2"></i>Apply Filters
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Scenarios List -->
                <div class="row g-4">
                    {% if group_scenarios %}
                        {% for group_scenario in group_scenarios %}
                            <div class="col-md-4">
                                <div class="base_card all_scenario_card h-100 shadow">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <h5 class="base_header mb-0">{{ group_scenario.scenario.name }}</h5>
                                            <span class="badge bg-primary">{{ group_scenario.group.name }}</span>
                                        </div>
                                        <div class="info_use">
                                            <small>
                                                <i class="fa-brands fa-docker me-2"></i>
                                                {{ group_scenario.scenario.docker_name }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="scenario_all_footer">
                                        <div class="d-flex gap-2">
                                            <a href="{% url 'tutorial:ListTutorials' group_scenario.scenario.id %}"
                                               class="btn btn-info btn-sm">
                                                <i class="fas fa-book me-2"></i>Tutorial
                                            </a>
                                            <a href="{% url 'scenario:ScenarioAddDescription' group_scenario.scenario.id %}"
                                               class="btn btn-info btn-sm">
                                                <i class="fas fa-list me-2"></i>Description
                                            </a>
                                            <a href="{% url 'quiz:CreateQuiz' group_scenario.scenario.id %}"
                                               class="btn btn-primary btn-sm">
                                                <i class="fas fa-list-check me-2"></i>Quiz
                                            </a>
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editScenarioModal{{ group_scenario.scenario.id }}">
                                                <i class="fas fa-edit me-2"></i>Edit
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                    onclick="confirmDelete('{{ group_scenario.scenario.name }}', '{{ group_scenario.scenario.id }}')">
                                                <i class="fas fa-trash me-2"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12">
                            <div class="base_card all_scenario_card shadow">
                                <div class="card-body text-center py-5 d-flex align-items-center justify-content-center">
                                    <div>
                                        <i class="fas fa-laptop-code fa-3x mb-3 base_title"
                                           style="color: rgba(255, 255, 255, 0.6);"></i>
                                        <h5 class="base_header mb-0">No scenarios found matching your criteria.</h5>
                                        <p class="scenario_text">Try adjusting your filters or create a new
                                            scenario.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Edit Scenario Modal -->
        {% for group_scenario in group_scenarios %}
            <div class="modal fade base_modal" id="editScenarioModal{{ group_scenario.scenario.id }}" tabindex="-1"
                 aria-labelledby="editScenarioModalLabel{{ group_scenario.scenario.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content base_modal_content">
                        <div class="modal-header group_modal_header">
                            <h5 class="modal-title" id="editScenarioModalLabel{{ group_scenario.scenario.id }}">
                                Edit Scenario
                            </h5></div>
                        <form method="post" action="{% url 'scenario:edit_scenario' group_scenario.scenario.id %}">
                            {% csrf_token %}
                            <div class="modal-body">
                                <div class="form-floating mb-3">
                                    <i class="fas fa-bookmark form_icon"></i>
                                    <input type="text" class="form-control"
                                           id="name{{ group_scenario.scenario.id }}"
                                           name="name" value="{{ group_scenario.scenario.name }}" required>
                                    <label for="name{{ group_scenario.scenario.id }}">Scenario Name</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <textarea class="form-control custom_form_control"
                                              id="description{{ group_scenario.scenario.id }}"
                                              name="description" rows="3"
                                              required>{{ group_scenario.scenario.description }}</textarea>
                                    <label for="description{{ group_scenario.scenario.id }}"
                                    >Description</label>
                                    <i class="fas fa-align-left position-absolute top-0 start-0 ms-3 mt-3 text-white"></i>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control custom_form_control"
                                           id="docker_image{{ group_scenario.scenario.id }}"
                                           name="docker_image" value="{{ group_scenario.scenario.docker_name }}"
                                           required>
                                    <label for="docker_image{{ group_scenario.scenario.id }}">Docker
                                        Image</label>
                                    <i class="fab fa-docker position-absolute top-50 start-0 translate-middle-y ms-3 text-white"></i>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn_close_modal" data-bs-dismiss="modal">Cancel
                                </button>
                                <button type="submit" class="btn btn-primary btn-custom">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
    <script>
        async function confirmDelete(scenarioName, scenarioId) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                html: `You want to delete the scenario "<strong>${scenarioName}</strong>"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/scenario/${scenarioId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });

                    if (response.ok) {
                        await Swal.fire({
                            title: 'Deleted!',
                            text: 'The scenario has been deleted.',
                            icon: 'success'
                        });
                        location.reload();
                    } else {
                        throw new Error('Failed to delete scenario');
                    }
                } catch (error) {
                    Swal.fire({
                        title: 'Error!',
                        text: error.message,
                        icon: 'error'
                    });
                }
            }
        }
    </script>
{% endblock %}