{% extends "base.html" %}
{% load static %}

{% block title %}Tutorial - {{ scenario.name }}{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <style>
        .tutorial-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            padding: 2rem;
        }

        .tutorial-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tutorial-header {
            margin-bottom: 2.5rem;
        }

        .tutorial-header h2 {
            color: #fff;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .tutorial-header p {
            color: rgba(255, 255, 255, 0.6);
        }

        .sections-container {
            display: grid;
            gap: 1.5rem;
        }

        .section-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            color: #fff;
        }

        .section-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header h3 {
            color: #fff;
            font-size: 1.25rem;
            margin: 0;
        }

        .section-preview {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .section-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Modal Styles */
        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.3);
        }
    </style>
{% endblock %}

{% block content %}
    <div class="animated_background bg_fi"></div>
    <div class="tutorial-container">
        <div class="tutorial-card">
            <div class="tutorial-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-0">{{ tutorial.title }}</h2>
                    </div>
                    <a href="{% url 'scenario:list_all_scenarios' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Scenario
                    </a>
                </div>
            </div>

            <div class="tutorial-content">
                <div class="section-actions mb-4">
                    <button class="btn btn-primary btn-custom" onclick="openAddSectionModal('{{ tutorial.id }}')">
                        <i class="fas fa-plus me-2"></i>Add Section
                    </button>
                </div>

                <div class="sections-container">
                    {% for section in tutorial.sections.all %}
                        <div class="section-item">
                            <div class="section-header">
                                <h3>{{ section.title }}</h3>
                                <div class="section-actions">
                                    <button class="btn btn-outline-primary btn-sm"
                                            onclick="openEditSectionModal('{{ section.id }}', '{{ section.title|escapejs }}', '{{ section.content|escapejs }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm"
                                            onclick="deleteSection('{{ section.id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="section-preview">
                                {{ section.content|safe }}
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center text-muted">
                            <i class="fas fa-book fa-3x mb-3"></i>
                            <p>No sections added yet. Click the "Add Section" button to get started.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Add Section Modal -->
    <div class="modal fade base_modal" id="addSectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content ">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Section</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addSectionForm" method="post" action="{% url 'tutorial:AddSection' %}"
                      onsubmit="return submitAddSection(event)">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="tutorialId" name="tutorial_id">
                        <div class="form-floating  custom_form_floating mb-3">
                            <i class="fas fa-bookmark form_icon"></i>
                            <input id="modal_tutorial_title" type="text" class="form-control custom_form_control"
                                   name="title" placeholder="" required>
                            <label for="modal_tutorial_title">Section Title</label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea id="addSectionContent" class="form-control" name="content" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn_close_modal" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary btn-custom">Add Section</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Section Modal -->
    <div class="modal fade" id="editSectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Section</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editSectionForm" method="post" action="{% url 'tutorial:EditSection' %}"
                      onsubmit="return submitEditSection(event)">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="sectionId" name="section_id">
                        <div class="form-floating mb-3">
                            <i class="fas fa-bookmark form_icon"></i>
                            <input id="edit_tutorial_modal" type="text" class="form-control" name="title"
                                   placeholder="">
                            <label for="edit_tutorial_modal">Section Title</label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea id="editSectionContent" class="form-control" name="content" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn_close_modal" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary btn-custom">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{% static 'js/tinymce/tinymce.min.js' %}"></script>
    <script>
        const tinyMCEConfig = {
            height: 300,
            plugins: 'lists link image',
            toolbar: 'styles | bold italic | bullist numlist | image',
            menubar: false,
            statusbar: false,
            skin: 'oxide-dark',
            content_css: 'dark',
            content_style: `
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                    font-size: 14px;
                    color: #fff;
                    background-color: rgba(30, 41, 59, 0.8) !important;
                    padding: 1rem;
                }
                p { color: #fff !important; }
                td { color: #fff !important; }
            `,
            images_upload_handler: async function (blobInfo, progress) {
                const formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());

                try {
                    const response = await fetch('{% url "tutorial:UploadImage" %}', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result && result.location) {
                        return result.location;
                    }
                    throw new Error('Invalid server response');
                } catch (error) {
                    console.error('Upload failed:', error);
                    throw error;
                }
            }
        };

        function openAddSectionModal(tutorialId) {
            document.getElementById('tutorialId').value = tutorialId;
            const modal = new bootstrap.Modal(document.getElementById('addSectionModal'));
            tinymce.init({
                ...tinyMCEConfig,
                selector: '#addSectionContent'
            });
            modal.show();
        }

        function openEditSectionModal(sectionId, title, content) {
            const form = document.getElementById('editSectionForm');
            form.querySelector('#sectionId').value = sectionId;
            form.querySelector('[name="title"]').value = title;

            tinymce.init({
                ...tinyMCEConfig,
                selector: '#editSectionContent',
                setup: function (editor) {
                    editor.on('init', function () {
                        editor.setContent(content);
                    });
                }
            });

            new bootstrap.Modal(document.getElementById('editSectionModal')).show();
        }

        function submitAddSection(event) {
            event.preventDefault();

            const content = tinymce.get('addSectionContent').getContent();
            const title = document.querySelector('input[name="title"]').value;

            if (!title.trim()) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please enter a section title',
                    icon: 'error'
                });
                return false;
            }

            if (!content.trim()) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please enter section content',
                    icon: 'error'
                });
                return false;
            }

            document.getElementById('addSectionForm').submit();
            return true;
        }

        async function submitEditSection(event) {
            event.preventDefault();
            
            // Add validation
            const content = tinymce.get('editSectionContent').getContent();
            const title = event.target.querySelector('[name="title"]').value;

            if (!title.trim()) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please enter a section title',
                    icon: 'error'
                });
                return false;
            }

            if (!content.trim()) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please enter section content',
                    icon: 'error'
                });
                return false;
            }

            const form = event.target;
            const formData = new FormData(form);
            formData.set('content', content);  // Use the content we validated above

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Section updated successfully'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    throw new Error('Failed to edit section');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message
                });
            }
            return false;
        }

        async function deleteSection(sectionId) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                reverseButtons: true,
                confirmButtonText: 'Yes, delete it!'
            });

            if (result.isConfirmed) {
                try {
                    const url = "{% url 'tutorial:DeleteSection' 999999 %}".replace('999999', sectionId);
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });

                    if (response.ok) {
                        Swal.fire(
                            'Deleted!',
                            'Section has been deleted.',
                            'success'
                        ).then(() => {
                            location.reload();
                        });
                    } else {
                        throw new Error('Failed to delete section');
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message
                    });
                }
            }
        }

        document.addEventListener('hidden.bs.modal', function (event) {
            if (event.target.id === 'addSectionModal') {
                tinymce.get('addSectionContent')?.remove();
            } else if (event.target.id === 'editSectionModal') {
                tinymce.get('editSectionContent')?.remove();
            }
        }, false);
    </script>
{% endblock %}